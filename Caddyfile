# Caddy Configuration for Smart Bookmarks
# Automatic HTTPS with Let's Encrypt

{
    # Global options
    email {$EMAIL}

    # Enable automatic HTTPS
    auto_https on

    # Access logs
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# Main application domain
{$DOMAIN:localhost} {
    # Enable compression
    encode gzip zstd

    # Security headers
    header {
        # HSTS (2 years)
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"

        # XSS protection
        X-XSS-Protection "1; mode=block"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Permissions policy
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # Remove server header
        -Server
    }

    # API routes
    handle /api/* {
        # Rate limiting at proxy level
        @abuse {
            path /api/*
        }

        # Reverse proxy to backend
        reverse_proxy backend-api:3002 {
            # Health check
            health_uri /health
            health_interval 30s
            health_timeout 5s

            # Load balancing (for future horizontal scaling)
            lb_policy round_robin
            lb_try_duration 5s

            # Timeouts
            transport http {
                dial_timeout 5s
                response_header_timeout 30s
                read_timeout 60s
                write_timeout 60s
            }

            # Pass real IP to backend
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Frontend routes (catch-all)
    handle {
        # Reverse proxy to frontend
        reverse_proxy frontend:3000 {
            # Health check
            health_uri /
            health_interval 30s
            health_timeout 10s

            # Timeouts
            transport http {
                dial_timeout 5s
                response_header_timeout 30s
                read_timeout 60s
                write_timeout 60s
            }

            # Pass real IP to frontend
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Access logging
    log {
        output file /var/log/caddy/{$DOMAIN}.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# Health check endpoint for Caddy itself
:80 {
    handle /health {
        respond "OK" 200
    }
}
