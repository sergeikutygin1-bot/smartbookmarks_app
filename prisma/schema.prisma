generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String?  @map("password_hash")
  googleId      String?  @unique @map("google_id")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  bookmarks Bookmark[]
  tags      Tag[]

  @@map("users")
}

model Bookmark {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  url          String
  title        String    @db.VarChar(500)
  domain       String    @db.VarChar(255)
  source       String?   @db.VarChar(255)
  summary      String?   @db.Text
  keyPoints    String[]  @map("key_points")
  contentType  String    @default("other") @map("content_type") @db.VarChar(50)
  status       String    @default("pending") @db.VarChar(50)
  metadata     Json?     @db.JsonB
  embedding    Unsupported("vector(1536)")?
  searchVector Unsupported("tsvector")?     @map("search_vector")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  processedAt  DateTime? @map("processed_at")

  user User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags BookmarkTag[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([domain])
  @@index([status])
  @@map("bookmarks")
}

model Tag {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  name           String   @db.VarChar(100)
  normalizedName String   @map("normalized_name") @db.VarChar(100)
  color          String?  @db.VarChar(7)
  createdAt      DateTime @default(now()) @map("created_at")

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookmarks BookmarkTag[]

  @@unique([userId, normalizedName])
  @@map("tags")
}

model BookmarkTag {
  bookmarkId    String  @map("bookmark_id")
  tagId         String  @map("tag_id")
  autoGenerated Boolean @default(false) @map("auto_generated")

  bookmark Bookmark @relation(fields: [bookmarkId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([bookmarkId, tagId])
  @@map("bookmark_tags")
}
